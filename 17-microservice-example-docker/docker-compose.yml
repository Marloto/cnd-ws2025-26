services:
  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: microservices-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth
      - posts
      - frontend
  # MongoDB for auth service
  mongodb:
    image: mongo:latest
    container_name: microservices-mongodb
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    environment:
      MONGO_INITDB_DATABASE: auth
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
  
  # Authentification service in auth/
  auth:
    restart: unless-stopped
    build:
      context: auth/
    environment:
      - "MONGO_DB_URL=mongodb://mongodb:27017/auth"
      - "JWT_SECRET=${SECRET:-dev-secret-key-min-32-chars-change-in-prod}"
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -O /dev/null -q http://localhost:3001/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
  
  # Database for posts service
  mysqldb:
    image: mysql:9
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      - "MYSQL_USER=${MYSQL_USER:-posts_user}"
      - "MYSQL_PASSWORD=${MYSQL_PASSWORD:-posts_password}"
      - "MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}"
      - "MYSQL_DATABASE=${MYSQL_DATABASE:-posts_db}"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Post service in posts/
  posts:
    restart: unless-stopped
    build:
      context: posts/
    environment:
      - "SPRING_JPA_HIBERNATE_DDL_AUTO=update"
      - "SPRING_DATASOURCE_URL=jdbc:mysql://mysqldb:3306/${MYSQL_DATABASE:-posts_db}"
      - "SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-posts_user}"
      - "SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:-posts_password}"
      - "SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.jdbc.Driver"
      - "MQTT_BROKER=tcp://mosquitto:1883"
      - "JWT_SECRET=${SECRET:-dev-secret-key-min-32-chars-change-in-prod}"
    depends_on:
      mysqldb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -O /dev/null -q http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # Simple frontend from frontend/
  frontend:
    restart: unless-stopped
    build:
      context: frontend/
    configs:
      - source: frontend-config
        target: /usr/share/nginx/html/js/config.js

  # Mosquitto MQTT broker for posts service
  mosquitto:
    image: eclipse-mosquitto
    container_name: microservices-mosquitto
    restart: unless-stopped
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 nc -z localhost 1883 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

configs:
  frontend-config:
    content: |
      const AUTH_API_BASE = 'http://localhost/auth';
      const POSTS_API_BASE = 'http://localhost/posts';

volumes:
  mongodb-data:
  mosquitto-data:
  mosquitto-log:
  mysql-data:
